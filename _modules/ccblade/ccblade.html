
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ccblade.ccblade &#8212; CCBlade 1.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/nrel.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CCBlade 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ccblade.ccblade</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ccblade.py</span>
<span class="sd">Created by S. Andrew Ning on 5/11/2012</span>
<span class="sd">Copyright (c) NREL. All rights reserved.</span>
<span class="sd">A blade element momentum method using theory detailed in [1]_.  Has the</span>
<span class="sd">advantages of guaranteed convergence and at a superlinear rate, and</span>
<span class="sd">continuously differentiable output.</span>
<span class="sd">.. [1] S. Andrew Ning, &quot;A simple solution method for the blade element momentum</span>
<span class="sd">equations with guaranteed convergence&quot;, Wind Energy, 2013.</span>
<span class="sd">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">you may not use this file except in compliance with the License.</span>
<span class="sd">You may obtain a copy of the License at</span>
<span class="sd">   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="sd">Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">See the License for the specific language governing permissions and</span>
<span class="sd">limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">isnan</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">brentq</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">RectBivariateSpline</span><span class="p">,</span> <span class="n">bisplev</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">airfoilprep</span> <span class="k">import</span> <span class="n">Airfoil</span>
<span class="kn">import</span> <span class="nn">_bem</span>



<span class="c1"># ------------------</span>
<span class="c1">#  Airfoil Class</span>
<span class="c1"># ------------------</span>


<div class="viewcode-block" id="CCAirfoil"><a class="viewcode-back" href="../../documentation.html#ccblade.CCAirfoil">[docs]</a><span class="k">class</span> <span class="nc">CCAirfoil</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A helper class to evaluate airfoil data using a continuously</span>
<span class="sd">    differentiable cubic spline&quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Setup CCAirfoil from raw airfoil data on a grid.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : array_like (deg)</span>
<span class="sd">            angles of attack where airfoil data are defined</span>
<span class="sd">            (should be defined from -180 to +180 degrees)</span>
<span class="sd">        Re : array_like</span>
<span class="sd">            Reynolds numbers where airfoil data are defined</span>
<span class="sd">            (can be empty or of length one if not Reynolds number dependent)</span>
<span class="sd">        cl : array_like</span>
<span class="sd">            lift coefficient 2-D array with shape (alpha.size, Re.size)</span>
<span class="sd">            cl[i, j] is the lift coefficient at alpha[i] and Re[j]</span>
<span class="sd">        cd : array_like</span>
<span class="sd">            drag coefficient 2-D array with shape (alpha.size, Re.size)</span>
<span class="sd">            cd[i, j] is the drag coefficient at alpha[i] and Re[j]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_Re</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_cm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_cm</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># special case if zero or one Reynolds number (need at least two for bivariate spline)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Re</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Re</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e1</span><span class="p">,</span> <span class="mf">1e15</span><span class="p">]</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">cl</span><span class="p">,</span> <span class="n">cl</span><span class="p">]</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">cd</span><span class="p">,</span> <span class="n">cd</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cm</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">cm</span><span class="p">,</span> <span class="n">cm</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">one_Re</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">kx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ky</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Re</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># a small amount of smoothing is used to prevent spurious multiple solutions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>     <span class="o">=</span> <span class="n">alpha</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cm_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>


<div class="viewcode-block" id="CCAirfoil.initFromAerodynFile"><a class="viewcode-back" href="../../documentation.html#ccblade.CCAirfoil.initFromAerodynFile">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">initFromAerodynFile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">aerodynFile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convenience method for initializing with AeroDyn formatted files</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        aerodynFile : str</span>
<span class="sd">            location of AeroDyn style airfoiil file</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        af : CCAirfoil</span>
<span class="sd">            a constructed CCAirfoil object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">af</span> <span class="o">=</span> <span class="n">Airfoil</span><span class="o">.</span><span class="n">initFromAerodynFile</span><span class="p">(</span><span class="n">aerodynFile</span><span class="p">)</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">createDataGrid</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">max_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Re</span><span class="p">):</span>
        <span class="c1"># Get the angle of attack, cl and cd at max airfoil efficiency. For a cylinder, set the angle of attack to 0</span>
        
        <span class="n">Eff</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        
        <span class="c1"># Check efficiency only between -20 and +40 deg</span>
        <span class="n">aoa_start</span>   <span class="o">=</span> <span class="o">-</span><span class="mf">20.</span>
        <span class="n">aoa_end</span>     <span class="o">=</span> <span class="mi">40</span>
        <span class="n">i_start</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="n">aoa_start</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span>
        <span class="n">i_end</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="n">aoa_end</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i_start</span><span class="p">:</span><span class="n">i_end</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Cylinder</span>
            <span class="n">alpha_Emax</span>  <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">cl_Emax</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha_Emax</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
            <span class="n">cd_Emax</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha_Emax</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="n">cl_Emax</span><span class="o">/</span><span class="n">cd_Emax</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">aoa_start</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">,</span> <span class="n">aoa_end</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">aoa</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span> <span class="k">for</span> <span class="n">aoa</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">]</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">aoa</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span> <span class="k">for</span> <span class="n">aoa</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">]</span>
            <span class="n">Eff</span> <span class="o">=</span> <span class="p">[</span><span class="n">cli</span><span class="o">/</span><span class="n">cdi</span> <span class="k">for</span> <span class="n">cli</span><span class="p">,</span> <span class="n">cdi</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">)]</span>

            <span class="n">i_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Eff</span><span class="p">)</span>
            <span class="n">alpha_Emax</span>  <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i_max</span><span class="p">]</span>
            <span class="n">cl_Emax</span>     <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="n">i_max</span><span class="p">]</span>
            <span class="n">cd_Emax</span>     <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="n">i_max</span><span class="p">]</span>
            <span class="n">Emax</span>        <span class="o">=</span> <span class="n">Eff</span><span class="p">[</span><span class="n">i_max</span><span class="p">]</span>

        <span class="c1"># print Emax, alpha_Emax*180./np.pi, cl_Emax, cd_Emax</span>

        <span class="k">return</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">alpha_Emax</span><span class="p">,</span> <span class="n">cl_Emax</span><span class="p">,</span> <span class="n">cd_Emax</span>
        
        
    <span class="k">def</span> <span class="nf">awayfromstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
        <span class="c1"># Get the angle of attack, cl and cd with a margin (in degrees) from the stall point. For a cylinder, set the angle of attack to 0 deg</span>
        
        <span class="c1"># Eff         = np.zeros_like(self.alpha)</span>
        
        <span class="c1"># Look for stall only between -20 and +40 deg</span>
        <span class="n">aoa_start</span>   <span class="o">=</span> <span class="o">-</span><span class="mf">20.</span>
        <span class="n">aoa_end</span>     <span class="o">=</span> <span class="mi">40</span>
        <span class="n">i_start</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="n">aoa_start</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span>
        <span class="n">i_end</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="p">(</span><span class="n">aoa_end</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i_start</span><span class="p">:</span><span class="n">i_end</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Cylinder</span>
            <span class="n">alpha_op</span>   <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">aoa_start</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">,</span> <span class="n">aoa_end</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
            <span class="n">cl</span>      <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">aoa</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span> <span class="k">for</span> <span class="n">aoa</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">]</span>
            <span class="n">cd</span>      <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">aoa</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span> <span class="k">for</span> <span class="n">aoa</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">]</span>
            
            <span class="n">i_stall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
            <span class="n">alpha_stall</span>  <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i_stall</span><span class="p">]</span>
            <span class="n">alpha_op</span>     <span class="o">=</span> <span class="n">alpha_stall</span> <span class="o">-</span> <span class="n">margin</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        
        <span class="n">cl_op</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha_op</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
        <span class="n">cd_op</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha_op</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
        <span class="n">Eff_op</span>     <span class="o">=</span> <span class="n">cl_op</span><span class="o">/</span><span class="n">cd_op</span>
            
            
        <span class="c1"># print Emax, alpha_Emax*180./np.pi, cl_Emax, cd_Emax</span>

        <span class="k">return</span> <span class="n">Eff_op</span><span class="p">,</span> <span class="n">alpha_op</span><span class="p">,</span> <span class="n">cl_op</span><span class="p">,</span> <span class="n">cd_op</span>
        
        
        


<div class="viewcode-block" id="CCAirfoil.evaluate"><a class="viewcode-back" href="../../documentation.html#ccblade.CCAirfoil.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">return_cm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get lift/drag coefficient at the specified angle of attack and Reynolds number.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float (rad)</span>
<span class="sd">            angle of attack</span>
<span class="sd">        Re : float</span>
<span class="sd">            Reynolds number</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cl : float</span>
<span class="sd">            lift coefficient</span>
<span class="sd">        cd : float</span>
<span class="sd">            drag coefficient</span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method uses a spline so that the output is continuously differentiable, and</span>
<span class="sd">        also uses a small amount of smoothing to help remove spurious multiple solutions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cm</span> <span class="ow">and</span> <span class="n">return_cm</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cm_spline</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span></div>


    <span class="k">def</span> <span class="nf">derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">):</span>

        <span class="c1"># note: direct call to bisplev will be unnecessary with latest scipy update (add derivative method)</span>
        <span class="n">tck_cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">tck</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_spline</span><span class="o">.</span><span class="n">degrees</span>  <span class="c1"># concatenate lists</span>
        <span class="n">tck_cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">tck</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd_spline</span><span class="o">.</span><span class="n">degrees</span>

        <span class="n">dcl_dalpha</span> <span class="o">=</span> <span class="n">bisplev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">tck_cl</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dcd_dalpha</span> <span class="o">=</span> <span class="n">bisplev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">tck_cd</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_Re</span><span class="p">:</span>
            <span class="n">dcl_dRe</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">dcd_dRe</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dcl_dRe</span> <span class="o">=</span> <span class="n">bisplev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">tck_cl</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dcd_dRe</span> <span class="o">=</span> <span class="n">bisplev</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">tck_cd</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dcl_dalpha</span><span class="p">,</span> <span class="n">dcl_dRe</span><span class="p">,</span> <span class="n">dcd_dalpha</span><span class="p">,</span> <span class="n">dcd_dRe</span>


    <span class="k">def</span> <span class="nf">eval_unsteady</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">cm</span><span class="p">):</span>
        <span class="c1"># calculate unsteady coefficients from polars for OpenFAST&#39;s Aerodyn</span>

        <span class="n">unsteady</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">alpha_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">cd</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_rad</span><span class="p">)</span>

        <span class="c1"># alpha0, Cd0, Cm0</span>
        <span class="n">aoa_l</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">30.</span><span class="p">]</span>
        <span class="n">aoa_h</span> <span class="o">=</span> <span class="p">[</span><span class="mf">30.</span><span class="p">]</span>
        <span class="n">idx_low</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">aoa_l</span><span class="p">))</span>
        <span class="n">idx_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">aoa_h</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cl</span><span class="p">)))</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">])</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cd0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">])</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cm0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">],</span> <span class="n">cm</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cd0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">0.</span><span class="p">))]</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cm0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>


        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;eta_e&#39;</span><span class="p">]</span><span class="o">=</span> <span class="mi">1</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;T_f0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;T_V0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;T_p&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;T_VL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;b5&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;A5&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;S2&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;S3&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;S4&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">find_breakpoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idx_low</span><span class="p">,</span> <span class="n">idx_high</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
            <span class="n">lin_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">idx_low</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]])</span>
            <span class="n">idx_break</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lin_diff</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">yi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lin_fit</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">multi</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yi</span><span class="o">-</span><span class="n">fit</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">diff_i</span> <span class="o">=</span> <span class="n">multi</span><span class="o">*</span><span class="p">(</span><span class="n">yi</span><span class="o">-</span><span class="n">fit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">diff_i</span><span class="o">&gt;</span><span class="n">lin_diff</span><span class="p">:</span>
                    <span class="n">lin_diff</span> <span class="o">=</span> <span class="n">diff_i</span>
                    <span class="n">idx_break</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">idx_break</span> <span class="o">+=</span> <span class="n">idx_low</span>
            <span class="k">return</span> <span class="n">idx_break</span>

        <span class="c1"># Cn1</span>
        <span class="n">idx_alpha0</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha0&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cm</span><span class="p">)))</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">aoa_h</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">idx_alpha0</span><span class="p">]</span><span class="o">+</span><span class="mf">35.</span>
            <span class="n">idx_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">aoa_h</span><span class="p">))</span>

            <span class="n">cm_temp</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">]</span>
            <span class="n">idx_cm_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">local_min</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">cm_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">cm_temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">cm_temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cm_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">True</span><span class="p">])</span> <span class="k">if</span> <span class="n">local_min</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_low</span>
            <span class="n">idx_high</span> <span class="o">=</span> <span class="n">idx_cm_min</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">idx_Cn1</span> <span class="o">=</span> <span class="n">find_breakpoint</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">idx_alpha0</span><span class="p">,</span> <span class="n">idx_high</span><span class="p">)</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn</span><span class="p">[</span><span class="n">idx_Cn1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_Cn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">0.</span><span class="p">))</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cn1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Cn2</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cm</span><span class="p">)))</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">aoa_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">alpha</span><span class="p">[</span><span class="n">idx_alpha0</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="n">idx_Cn1</span><span class="p">]])</span><span class="o">-</span><span class="mf">30.</span>
            <span class="n">idx_low</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">aoa_l</span><span class="p">))</span>

            <span class="n">cm_temp</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">]</span>
            <span class="n">idx_cm_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">local_min</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">cm_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">cm_temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">cm_temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cm_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">True</span><span class="p">])</span> <span class="k">if</span> <span class="n">local_min</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_low</span>
            <span class="n">idx_high</span> <span class="o">=</span> <span class="n">idx_cm_min</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">idx_Cn2</span> <span class="o">=</span> <span class="n">find_breakpoint</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">idx_low</span><span class="p">,</span> <span class="n">idx_alpha0</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cn2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cn</span><span class="p">[</span><span class="n">idx_Cn2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_Cn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">0.</span><span class="p">))</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cn2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># C_nalpha</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cm</span><span class="p">)))</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="c1"># unsteady[&#39;C_nalpha&#39;] = np.gradient(cn, alpha_rad)[idx_alpha0]</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;C_nalpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cn</span><span class="p">[</span><span class="n">idx_alpha0</span><span class="p">:</span><span class="n">idx_Cn1</span><span class="p">],</span> <span class="n">alpha_rad</span><span class="p">[</span><span class="n">idx_alpha0</span><span class="p">:</span><span class="n">idx_Cn1</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;C_nalpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># alpha1, alpha2</span>
        <span class="c1"># finding the break point in drag as a proxy for Trailing Edge separation, f=0.7</span>
        <span class="c1"># 3d stall corrections cause erroneous f calculations </span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">cm</span><span class="p">)))</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
            <span class="n">aoa_l</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
            <span class="n">idx_low</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="n">aoa_l</span><span class="p">))</span>
            <span class="n">idx_alpha1</span> <span class="o">=</span> <span class="n">find_breakpoint</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">idx_low</span><span class="p">,</span> <span class="n">idx_Cn1</span><span class="p">,</span> <span class="n">multi</span><span class="o">=-</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">idx_alpha1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_alpha1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mf">0.</span><span class="p">))</span>
            <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;alpha1&#39;</span><span class="p">]</span>


        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;St_sh&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;k0&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;k1&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;k2&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;k3&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;k1_hat&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;x_cp_bar&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;UACutout&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;filtCutOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>

        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Alpha&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">alpha</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">cl</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cd&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">cd</span>
        <span class="n">unsteady</span><span class="p">[</span><span class="s1">&#39;Cm&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">cm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unsteady</span> <span class="o">=</span> <span class="n">unsteady</span></div>

        <span class="c1"># import matplotlib.pyplot as plt</span>
        <span class="c1"># fig, ax = plt.subplots(nrows=3, ncols=1, figsize=(6., 8.), sharex=True)</span>
        <span class="c1"># ax[0].plot(alpha, cn)</span>
        <span class="c1"># ax[0].plot(alpha, cl, &#39;--&#39;)</span>
        <span class="c1"># ax[0].plot(unsteady[&#39;alpha0&#39;], 0.,&#39;o&#39;)</span>
        <span class="c1"># ax[0].annotate(&#39;alpha0&#39;, (unsteady[&#39;alpha0&#39;], 0.))</span>
        <span class="c1"># ax[0].plot(alpha[idx_alpha0], cn[idx_alpha0],&#39;o&#39;)</span>
        <span class="c1"># ax[0].annotate(&#39;C_nalpha&#39;, (alpha[idx_alpha0], cn[idx_alpha0]))</span>
        <span class="c1"># ax[0].plot(alpha[idx_Cn1], cn[idx_Cn1],&#39;o&#39;)</span>
        <span class="c1"># ax[0].annotate(&#39;Cn1&#39;, (alpha[idx_Cn1], cn[idx_Cn1]))</span>
        <span class="c1"># ax[0].plot(alpha[idx_Cn2], cn[idx_Cn2],&#39;o&#39;)</span>
        <span class="c1"># ax[0].annotate(&#39;Cn2&#39;, (alpha[idx_Cn2], cn[idx_Cn2]))</span>
        <span class="c1"># ax[0].set_ylabel(&#39;C_L&#39;)</span>
        <span class="c1"># ax[0].grid(True, linestyle=&#39;:&#39;)</span>

        <span class="c1"># ax[1].plot(alpha, cd)</span>
        <span class="c1"># ax[1].set_ylabel(&#39;C_D&#39;)</span>
        <span class="c1"># ax[1].grid(True, linestyle=&#39;:&#39;)</span>

        <span class="c1"># ax[2].plot(alpha, cm)</span>
        <span class="c1"># ax[2].plot(alpha[idx_Cn1], cm[idx_Cn1], &#39;o&#39;)</span>
        <span class="c1"># ax[2].annotate(&#39;Cn1&#39;, (alpha[idx_Cn1], cm[idx_Cn1]))</span>
        <span class="c1"># ax[2].plot(alpha[idx_Cn2], cm[idx_Cn2], &#39;o&#39;)</span>
        <span class="c1"># ax[2].annotate(&#39;Cn2&#39;, (alpha[idx_Cn2], cm[idx_Cn2]))</span>

        <span class="c1"># ax[2].set_ylabel(&#39;C_M&#39;)</span>
        <span class="c1"># ax[2].set_xlabel(&#39;Angle of Attack, deg&#39;)</span>
        <span class="c1"># ax[2].grid(True, linestyle=&#39;:&#39;)</span>

        <span class="c1"># plt.show()</span>

<span class="c1"># ------------------</span>
<span class="c1">#  Main Class: CCBlade</span>
<span class="c1"># ------------------</span>


<div class="viewcode-block" id="CCBlade"><a class="viewcode-back" href="../../documentation.html#ccblade.CCBlade">[docs]</a><span class="k">class</span> <span class="nc">CCBlade</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Rhub</span><span class="p">,</span> <span class="n">Rtip</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">1.225</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">1.81206e-5</span><span class="p">,</span>
                 <span class="n">precone</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yaw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">shearExp</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hubHt</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>
                 <span class="n">nSector</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">precurve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precurveTip</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">presweep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">presweepTip</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">tiploss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hubloss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wakerotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usecd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterRe</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">derivatives</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for aerodynamic rotor analysis</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : array_like (m)</span>
<span class="sd">            locations defining the blade along z-axis of :ref:`blade coordinate system &lt;azimuth_blade_coord&gt;`</span>
<span class="sd">            (values should be increasing).</span>
<span class="sd">        chord : array_like (m)</span>
<span class="sd">            corresponding chord length at each section</span>
<span class="sd">        theta : array_like (deg)</span>
<span class="sd">            corresponding :ref:`twist angle &lt;blade_airfoil_coord&gt;` at each section---</span>
<span class="sd">            positive twist decreases angle of attack.</span>
<span class="sd">        Rhub : float (m)</span>
<span class="sd">            location of hub</span>
<span class="sd">        Rtip : float (m)</span>
<span class="sd">            location of tip</span>
<span class="sd">        B : int, optional</span>
<span class="sd">            number of blades</span>
<span class="sd">        rho : float, optional (kg/m^3)</span>
<span class="sd">            freestream fluid density</span>
<span class="sd">        mu : float, optional (kg/m/s)</span>
<span class="sd">            dynamic viscosity of fluid</span>
<span class="sd">        precone : float, optional (deg)</span>
<span class="sd">            :ref:`hub precone angle &lt;azimuth_blade_coord&gt;`</span>
<span class="sd">        tilt : float, optional (deg)</span>
<span class="sd">            nacelle :ref:`tilt angle &lt;yaw_hub_coord&gt;`</span>
<span class="sd">        yaw : float, optional (deg)</span>
<span class="sd">            nacelle :ref:`yaw angle&lt;wind_yaw_coord&gt;`</span>
<span class="sd">        shearExp : float, optional</span>
<span class="sd">            shear exponent for a power-law wind profile across hub</span>
<span class="sd">        hubHt : float, optional</span>
<span class="sd">            hub height used for power-law wind profile.</span>
<span class="sd">            U = Uref*(z/hubHt)**shearExp</span>
<span class="sd">        nSector : int, optional</span>
<span class="sd">            number of azimuthal sectors to descretize aerodynamic calculation.  automatically set to</span>
<span class="sd">            ``1`` if tilt, yaw, and shearExp are all 0.0.  Otherwise set to a minimum of 4.</span>
<span class="sd">        precurve : array_like, optional (m)</span>
<span class="sd">            location of blade pitch axis in x-direction of :ref:`blade coordinate system &lt;azimuth_blade_coord&gt;`</span>
<span class="sd">        precurveTip : float, optional (m)</span>
<span class="sd">            location of blade pitch axis in x-direction at the tip (analogous to Rtip)</span>
<span class="sd">        presweep : array_like, optional (m)</span>
<span class="sd">            location of blade pitch axis in y-direction of :ref:`blade coordinate system &lt;azimuth_blade_coord&gt;`</span>
<span class="sd">        presweepTip : float, optional (m)</span>
<span class="sd">            location of blade pitch axis in y-direction at the tip (analogous to Rtip)</span>
<span class="sd">        tiploss : boolean, optional</span>
<span class="sd">            if True, include Prandtl tip loss model</span>
<span class="sd">        hubloss : boolean, optional</span>
<span class="sd">            if True, include Prandtl hub loss model</span>
<span class="sd">        wakerotation : boolean, optional</span>
<span class="sd">            if True, include effect of wake rotation (i.e., tangential induction factor is nonzero)</span>
<span class="sd">        usecd : boolean, optional</span>
<span class="sd">            If True, use drag coefficient in computing induction factors</span>
<span class="sd">            (always used in evaluating distributed loads from the induction factors).</span>
<span class="sd">            Note that the default implementation may fail at certain points if drag is not included</span>
<span class="sd">            (see Section 4.2 in :cite:`Ning2013A-simple-soluti`).  This can be worked around, but has</span>
<span class="sd">            not been implemented.</span>
<span class="sd">        iterRe : int, optional</span>
<span class="sd">            The number of iterations to use to converge Reynolds number.  Generally iterRe=1 is sufficient,</span>
<span class="sd">            but for high accuracy in Reynolds number effects, iterRe=2 iterations can be used.  More than that</span>
<span class="sd">            should not be necessary.  Gradients have only been implemented for the case iterRe=1.</span>
<span class="sd">        derivatives : boolean, optional</span>
<span class="sd">            if True, derivatives along with function values will be returned for the various methods</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="n">af</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rhub</span> <span class="o">=</span> <span class="n">Rhub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span> <span class="o">=</span> <span class="n">Rtip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precone</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">precone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shearExp</span> <span class="o">=</span> <span class="n">shearExp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hubHt</span> <span class="o">=</span> <span class="n">hubHt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bemoptions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">usecd</span><span class="o">=</span><span class="n">usecd</span><span class="p">,</span> <span class="n">tiploss</span><span class="o">=</span><span class="n">tiploss</span><span class="p">,</span> <span class="n">hubloss</span><span class="o">=</span><span class="n">hubloss</span><span class="p">,</span> <span class="n">wakerotation</span><span class="o">=</span><span class="n">wakerotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterRe</span> <span class="o">=</span> <span class="n">iterRe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span> <span class="o">=</span> <span class="n">derivatives</span>
        
        
        <span class="c1"># check if no precurve / presweep</span>
        <span class="k">if</span> <span class="n">precurve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">precurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">precurveTip</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">presweep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">presweep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">presweepTip</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">precurve</span> <span class="o">=</span> <span class="n">precurve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precurveTip</span> <span class="o">=</span> <span class="n">precurveTip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presweep</span> <span class="o">=</span> <span class="n">presweep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presweepTip</span> <span class="o">=</span> <span class="n">presweepTip</span>

        <span class="c1"># rotor radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurveTip</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">precone</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rotor diameter may be modified in unexpected ways if tip precurve and precone are both nonzero&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span> <span class="o">=</span> <span class="n">Rtip</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurveTip</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">)</span>


        <span class="c1"># azimuthal discretization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaw</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shearExp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nSector</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># no more are necessary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nSector</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">nSector</span><span class="p">)</span>  <span class="c1"># at least 4 are necessary</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">inverse_analysis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">induction</span>        <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># residual</span>
    <span class="k">def</span> <span class="nf">__runBEM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;residual of BEM method and other corresponding variables&quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterRe</span><span class="p">):</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Re</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">relativewind</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                                             <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>

            <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">inductionfactors</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rhub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span>
                                                 <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bemoptions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span>

    <span class="k">def</span> <span class="nf">__errorFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;strip other outputs leaving only residual for Brent&#39;s method</span>
<span class="sd">        Standard use case, geometry is known</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runBEM</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fzero</span>

    <span class="k">def</span> <span class="nf">__runBEM_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;residual of BEM method and other corresponding variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterRe</span><span class="p">):</span>

            <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">inductionfactors</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rhub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span>
                                                 <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bemoptions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span>


    <span class="k">def</span> <span class="nf">__errorFunction_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;strip other outputs leaving only residual for Brent&#39;s method</span>
<span class="sd">        Parametric optimization use case, desired Cl/Cd is known, solve for twist</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runBEM_inverse</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fzero</span>



    <span class="k">def</span> <span class="nf">__residualDerivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;derivatives of fzero, a, ap&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterRe</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Analytic derivatives not supplied for case with iterRe &gt; 1&#39;</span><span class="p">)</span>

        <span class="c1"># x = [phi, chord, theta, Vx, Vy, r, Rhub, Rtip, pitch]  (derivative order)</span>

        <span class="c1"># alpha, Re (analytic derivaives)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Re</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">relativewind</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                                         <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>

        <span class="n">dalpha_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">dRe_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Re</span><span class="o">/</span><span class="n">chord</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Re</span><span class="o">*</span><span class="n">Vx</span><span class="o">/</span><span class="n">W</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">Re</span><span class="o">*</span><span class="n">Vy</span><span class="o">/</span><span class="n">W</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="c1"># cl, cd (spline derivatives)</span>
        <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>
        <span class="n">dcl_dalpha</span><span class="p">,</span> <span class="n">dcl_dRe</span><span class="p">,</span> <span class="n">dcd_dalpha</span><span class="p">,</span> <span class="n">dcd_dRe</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>

        <span class="c1"># chain rule</span>
        <span class="n">dcl_dx</span> <span class="o">=</span> <span class="n">dcl_dalpha</span><span class="o">*</span><span class="n">dalpha_dx</span> <span class="o">+</span> <span class="n">dcl_dRe</span><span class="o">*</span><span class="n">dRe_dx</span>
        <span class="n">dcd_dx</span> <span class="o">=</span> <span class="n">dcd_dalpha</span><span class="o">*</span><span class="n">dalpha_dx</span> <span class="o">+</span> <span class="n">dcd_dRe</span><span class="o">*</span><span class="n">dRe_dx</span>

        <span class="c1"># residual, a, ap (Tapenade)</span>
        <span class="n">dx_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

        <span class="n">fzero</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">dR_dx</span><span class="p">,</span> <span class="n">da_dx</span><span class="p">,</span> <span class="n">dap_dx</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">inductionfactors_dv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rhub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span><span class="p">,</span>
            <span class="n">phi</span><span class="p">,</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">dx_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dcl_dx</span><span class="p">,</span> <span class="n">dcd_dx</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bemoptions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dR_dx</span><span class="p">,</span> <span class="n">da_dx</span><span class="p">,</span> <span class="n">dap_dx</span>



    <span class="k">def</span> <span class="nf">__loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">rotating</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;normal and tangential loads at one section (and optionally derivatives)&quot;&quot;&quot;</span>

        <span class="n">cphi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sphi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rotating</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runBEM</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
                
        <span class="n">alpha</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Re</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">relativewind</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                                         <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>
        <span class="n">cl</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>

        <span class="n">cn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">*</span><span class="n">cphi</span> <span class="o">+</span> <span class="n">cd</span><span class="o">*</span><span class="n">sphi</span>  <span class="c1"># these expressions should always contain drag</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">cl</span><span class="o">*</span><span class="n">sphi</span> <span class="o">-</span> <span class="n">cd</span><span class="o">*</span><span class="n">cphi</span>

        <span class="n">q</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">*</span><span class="n">W</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="n">cn</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chord</span>
        <span class="n">Tp</span> <span class="o">=</span> <span class="n">ct</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">chord</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>


        <span class="c1"># derivative of residual function</span>
        <span class="k">if</span> <span class="n">rotating</span><span class="p">:</span>
            <span class="n">dR_dx</span><span class="p">,</span> <span class="n">da_dx</span><span class="p">,</span> <span class="n">dap_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__residualDerivatives</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">)</span>
            <span class="n">dphi_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dR_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">dR_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># just to prevent divide by zero</span>
            <span class="n">da_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">dap_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">dphi_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

        <span class="c1"># x = [phi, chord, theta, Vx, Vy, r, Rhub, Rtip, pitch]  (derivative order)</span>
        <span class="n">dx_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">dchord_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

        <span class="c1"># alpha, W, Re (Tapenade)</span>

        <span class="n">alpha</span><span class="p">,</span> <span class="n">dalpha_dx</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">dW_dx</span><span class="p">,</span> <span class="n">Re</span><span class="p">,</span> <span class="n">dRe_dx</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">relativewind_dv</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">da_dx</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">dap_dx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:],</span> <span class="n">chord</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">theta</span><span class="p">,</span> <span class="n">dx_dx</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>

        <span class="c1"># cl, cd (spline derivatives)</span>
        <span class="n">dcl_dalpha</span><span class="p">,</span> <span class="n">dcl_dRe</span><span class="p">,</span> <span class="n">dcd_dalpha</span><span class="p">,</span> <span class="n">dcd_dRe</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Re</span><span class="p">)</span>

        <span class="c1"># chain rule</span>
        <span class="n">dcl_dx</span> <span class="o">=</span> <span class="n">dcl_dalpha</span><span class="o">*</span><span class="n">dalpha_dx</span> <span class="o">+</span> <span class="n">dcl_dRe</span><span class="o">*</span><span class="n">dRe_dx</span>
        <span class="n">dcd_dx</span> <span class="o">=</span> <span class="n">dcd_dalpha</span><span class="o">*</span><span class="n">dalpha_dx</span> <span class="o">+</span> <span class="n">dcd_dRe</span><span class="o">*</span><span class="n">dRe_dx</span>

        <span class="c1"># cn, cd</span>
        <span class="n">dcn_dx</span> <span class="o">=</span> <span class="n">dcl_dx</span><span class="o">*</span><span class="n">cphi</span> <span class="o">-</span> <span class="n">cl</span><span class="o">*</span><span class="n">sphi</span><span class="o">*</span><span class="n">dphi_dx</span> <span class="o">+</span> <span class="n">dcd_dx</span><span class="o">*</span><span class="n">sphi</span> <span class="o">+</span> <span class="n">cd</span><span class="o">*</span><span class="n">cphi</span><span class="o">*</span><span class="n">dphi_dx</span>
        <span class="n">dct_dx</span> <span class="o">=</span> <span class="n">dcl_dx</span><span class="o">*</span><span class="n">sphi</span> <span class="o">+</span> <span class="n">cl</span><span class="o">*</span><span class="n">cphi</span><span class="o">*</span><span class="n">dphi_dx</span> <span class="o">-</span> <span class="n">dcd_dx</span><span class="o">*</span><span class="n">cphi</span> <span class="o">+</span> <span class="n">cd</span><span class="o">*</span><span class="n">sphi</span><span class="o">*</span><span class="n">dphi_dx</span>

        <span class="c1"># Np, Tp</span>
        <span class="n">dNp_dx</span> <span class="o">=</span> <span class="n">Np</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">cn</span><span class="o">*</span><span class="n">dcn_dx</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">W</span><span class="o">*</span><span class="n">dW_dx</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chord</span><span class="o">*</span><span class="n">dchord_dx</span><span class="p">)</span>
        <span class="n">dTp_dx</span> <span class="o">=</span> <span class="n">Tp</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">ct</span><span class="o">*</span><span class="n">dct_dx</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">W</span><span class="o">*</span><span class="n">dW_dx</span> <span class="o">+</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chord</span><span class="o">*</span><span class="n">dchord_dx</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">dNp_dx</span><span class="p">,</span> <span class="n">dTp_dx</span><span class="p">,</span> <span class="n">dR_dx</span>




    <span class="k">def</span> <span class="nf">__windComponents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x, y components of wind in blade-aligned coordinate system&quot;&quot;&quot;</span>

        <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">windcomponents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">presweep</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hubHt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shearExp</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

        <span class="c1"># y = [r, precurve, presweep, precone, tilt, hubHt, yaw, azimuth, Uinf, Omega]  (derivative order)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">dy_dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">Vxd</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vyd</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">windcomponents_dv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurve</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presweep</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaw</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">Omega</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hubHt</span><span class="p">,</span> <span class="n">dy_dy</span><span class="p">[:,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shearExp</span><span class="p">)</span>

        <span class="n">dVx_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Vxd</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># off-diagonal terms are known to be zero and not needed</span>
        <span class="n">dVy_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Vyd</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>

        <span class="n">dVx_dcurve</span> <span class="o">=</span> <span class="n">Vxd</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># tri-diagonal  (note: dVx_j / dcurve_i  i==row)</span>
        <span class="n">dVy_dcurve</span> <span class="o">=</span> <span class="n">Vyd</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># off-diagonal are actually all zero, but leave for convenience</span>

        <span class="n">dVx_dsweep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Vxd</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># off-diagonal terms are known to be zero and not needed</span>
        <span class="n">dVy_dsweep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Vyd</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># w = [r, presweep, precone, tilt, hubHt, yaw, azimuth, Uinf, Omega]</span>
        <span class="n">dVx_dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dVx_dr</span><span class="p">,</span> <span class="n">dVx_dsweep</span><span class="p">,</span> <span class="n">Vxd</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">:,</span> <span class="p">:]))</span>
        <span class="n">dVy_dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dVy_dr</span><span class="p">,</span> <span class="n">dVy_dsweep</span><span class="p">,</span> <span class="n">Vyd</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">:,</span> <span class="p">:]))</span>

        <span class="k">return</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">dVx_dw</span><span class="p">,</span> <span class="n">dVy_dw</span><span class="p">,</span> <span class="n">dVx_dcurve</span><span class="p">,</span> <span class="n">dVy_dcurve</span>




<div class="viewcode-block" id="CCBlade.distributedAeroLoads"><a class="viewcode-back" href="../../documentation.html#ccblade.CCBlade.distributedAeroLoads">[docs]</a>    <span class="k">def</span> <span class="nf">distributedAeroLoads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute distributed aerodynamic loads along blade.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Uinf : float or array_like (m/s)</span>
<span class="sd">            hub height wind speed (float).  If desired, an array can be input which specifies</span>
<span class="sd">            the velocity at each radial location along the blade (useful for analyzing loads</span>
<span class="sd">            behind tower shadow for example).  In either case shear corrections will be applied.</span>
<span class="sd">        Omega : float (RPM)</span>
<span class="sd">            rotor rotation speed</span>
<span class="sd">        pitch : float (deg)</span>
<span class="sd">            blade pitch in same direction as :ref:`twist &lt;blade_airfoil_coord&gt;`</span>
<span class="sd">            (positive decreases angle of attack)</span>
<span class="sd">        azimuth : float (deg)</span>
<span class="sd">            the :ref:`azimuth angle &lt;hub_azimuth_coord&gt;` where aerodynamic loads should be computed at</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Np : ndarray (N/m)</span>
<span class="sd">            force per unit length normal to the section on downwind side</span>
<span class="sd">        Tp : ndarray (N/m)</span>
<span class="sd">            force per unit length tangential to the section in the direction of rotation</span>
<span class="sd">        dNp : dictionary containing arrays (present if ``self.derivatives = True``)</span>
<span class="sd">            derivatives of normal loads.  Each item in the dictionary a 2D Jacobian.</span>
<span class="sd">            The array sizes and keys are (where n = number of stations along blade):</span>
<span class="sd">            n x n (diagonal): &#39;dr&#39;, &#39;dchord&#39;, &#39;dtheta&#39;, &#39;dpresweep&#39;</span>
<span class="sd">            n x n (tridiagonal): &#39;dprecurve&#39;</span>
<span class="sd">            n x 1: &#39;dRhub&#39;, &#39;dRtip&#39;, &#39;dprecone&#39;, &#39;dtilt&#39;, &#39;dhubHt&#39;, &#39;dyaw&#39;, &#39;dazimuth&#39;, &#39;dUinf&#39;, &#39;dOmega&#39;, &#39;dpitch&#39;</span>
<span class="sd">            for example dNp_dr = dNp[&#39;dr&#39;]  (where dNp_dr is an n x n array)</span>
<span class="sd">            and dNp_dr[i, j] = dNp_i / dr_j</span>
<span class="sd">        dTp : dictionary (present if ``self.derivatives = True``)</span>
<span class="sd">            derivatives of tangential loads.  Same keys as dNp.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>

        <span class="c1"># component of velocity at each radial station</span>
        <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">dVx_dw</span><span class="p">,</span> <span class="n">dVy_dw</span><span class="p">,</span> <span class="n">dVx_dcurve</span><span class="p">,</span> <span class="n">dVy_dcurve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__windComponents</span><span class="p">(</span><span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">)</span>


        <span class="c1"># initialize</span>
        <span class="n">n</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">a</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">Tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">dNp_dVx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">dTp_dVx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">dNp_dVy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">dTp_dVy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">dNp_dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">dTp_dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_analysis</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">errf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__errorFunction_inverse</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__errorFunction</span>
        <span class="n">rotating</span> <span class="o">=</span> <span class="p">(</span><span class="n">Omega</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># ---------------- loop across blade ------------------</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

            <span class="c1"># index dependent arguments</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_analysis</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rotating</span><span class="p">:</span>  <span class="c1"># non-rotating</span>

                <span class="n">phi_star</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># ------ BEM solution method see (Ning, doi:10.1002/we.1636) ------</span>

                <span class="c1"># set standard limits</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span>
                <span class="n">phi_lower</span> <span class="o">=</span> <span class="n">epsilon</span>
                <span class="n">phi_upper</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>

                <span class="k">if</span> <span class="n">errf</span><span class="p">(</span><span class="n">phi_lower</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">*</span><span class="n">errf</span><span class="p">(</span><span class="n">phi_upper</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># an uncommon but possible case</span>

                    <span class="k">if</span> <span class="n">errf</span><span class="p">(</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">errf</span><span class="p">(</span><span class="o">-</span><span class="n">epsilon</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">phi_lower</span> <span class="o">=</span> <span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span>
                        <span class="n">phi_upper</span> <span class="o">=</span> <span class="o">-</span><span class="n">epsilon</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">phi_lower</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">phi_upper</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">-</span> <span class="n">epsilon</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">phi_star</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">errf</span><span class="p">,</span> <span class="n">phi_lower</span><span class="p">,</span> <span class="n">phi_upper</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;error.  check input values.&#39;</span><span class="p">)</span>
                    <span class="n">phi_star</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># ----------------------------------------------------------------</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_analysis</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">phi_star</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="c1"># rad</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chord</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># derivatives of residual</span>

            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Np</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Tp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dNp_dx</span><span class="p">,</span> <span class="n">dTp_dx</span><span class="p">,</span> <span class="n">dR_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loads</span><span class="p">(</span><span class="n">phi_star</span><span class="p">,</span> <span class="n">rotating</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">Np</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">Np</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">Tp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="c1"># print(&#39;warning, BEM convergence error, setting Np[%d] = Tp[%d] = 0.&#39; % (i,i))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
                <span class="c1"># separate state vars from design vars</span>
                <span class="c1"># x = [phi, chord, theta, Vx, Vy, r, Rhub, Rtip, pitch]  (derivative order)</span>
                <span class="n">dNp_dy</span> <span class="o">=</span> <span class="n">dNp_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dNp_dx</span> <span class="o">=</span> <span class="n">dNp_dx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dTp_dy</span> <span class="o">=</span> <span class="n">dTp_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dTp_dx</span> <span class="o">=</span> <span class="n">dTp_dx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dR_dy</span> <span class="o">=</span> <span class="n">dR_dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dR_dx</span> <span class="o">=</span> <span class="n">dR_dx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="c1"># direct (or adjoint) total derivatives</span>
                <span class="n">DNp_Dx</span> <span class="o">=</span> <span class="n">dNp_dx</span> <span class="o">-</span> <span class="n">dNp_dy</span><span class="o">/</span><span class="n">dR_dy</span><span class="o">*</span><span class="n">dR_dx</span>
                <span class="n">DTp_Dx</span> <span class="o">=</span> <span class="n">dTp_dx</span> <span class="o">-</span> <span class="n">dTp_dy</span><span class="o">/</span><span class="n">dR_dy</span><span class="o">*</span><span class="n">dR_dx</span>

                <span class="c1"># parse components</span>
                <span class="c1"># z = [r, chord, theta, Rhub, Rtip, pitch]</span>
                <span class="n">zidx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
                <span class="n">dNp_dz</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DNp_Dx</span><span class="p">[</span><span class="n">zidx</span><span class="p">]</span>
                <span class="n">dTp_dz</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTp_Dx</span><span class="p">[</span><span class="n">zidx</span><span class="p">]</span>

                <span class="n">dNp_dVx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DNp_Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">dTp_dVx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTp_Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">dNp_dVy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DNp_Dx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dTp_dVy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTp_Dx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">induction</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># chain rule</span>
            <span class="n">dNp_dw</span> <span class="o">=</span> <span class="n">dNp_dVx</span><span class="o">*</span><span class="n">dVx_dw</span> <span class="o">+</span> <span class="n">dNp_dVy</span><span class="o">*</span><span class="n">dVy_dw</span>
            <span class="n">dTp_dw</span> <span class="o">=</span> <span class="n">dTp_dVx</span><span class="o">*</span><span class="n">dVx_dw</span> <span class="o">+</span> <span class="n">dTp_dVy</span><span class="o">*</span><span class="n">dVy_dw</span>

            <span class="n">dNp_dprecurve</span> <span class="o">=</span> <span class="n">dNp_dVx</span><span class="o">*</span><span class="n">dVx_dcurve</span> <span class="o">+</span> <span class="n">dNp_dVy</span><span class="o">*</span><span class="n">dVy_dcurve</span>
            <span class="n">dTp_dprecurve</span> <span class="o">=</span> <span class="n">dTp_dVx</span><span class="o">*</span><span class="n">dVx_dcurve</span> <span class="o">+</span> <span class="n">dTp_dVy</span><span class="o">*</span><span class="n">dVy_dcurve</span>

            <span class="c1"># stack</span>
            <span class="c1"># z = [r, chord, theta, Rhub, Rtip, pitch]</span>
            <span class="c1"># w = [r, presweep, precone, tilt, hubHt, yaw, azimuth, Uinf, Omega]</span>
            <span class="c1"># X = [r, chord, theta, Rhub, Rtip, presweep, precone, tilt, hubHt, yaw, azimuth, Uinf, Omega, pitch]</span>
            <span class="n">dNp_dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dNp_dw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># add partial w.r.t. r</span>
            <span class="n">dTp_dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dTp_dw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">dNp_dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dNp_dz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dNp_dw</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">dNp_dz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="n">dTp_dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dTp_dz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dTp_dw</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">dTp_dz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="c1"># add chain rule for conversion to radians</span>
            <span class="n">ridx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
            <span class="n">dNp_dX</span><span class="p">[</span><span class="n">ridx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>
            <span class="n">dTp_dX</span><span class="p">[</span><span class="n">ridx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>

            <span class="c1"># save these values as the packing in one matrix is convenient for evaluate</span>
            <span class="c1"># (intended for internal use only.  not to be accessed by user)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dNp_dX</span> <span class="o">=</span> <span class="n">dNp_dX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dTp_dX</span> <span class="o">=</span> <span class="n">dTp_dX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dNp_dprecurve</span> <span class="o">=</span> <span class="n">dNp_dprecurve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dTp_dprecurve</span> <span class="o">=</span> <span class="n">dTp_dprecurve</span>

            <span class="c1"># pack derivatives into dictionary</span>
            <span class="n">dNp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dTp</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># n x n (diagonal)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dNp_dX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dTp_dX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dchord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dNp_dX</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dchord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dTp_dX</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dNp_dX</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dTp_dX</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dpresweep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dNp_dX</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dpresweep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dTp_dX</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:])</span>

            <span class="c1"># n x n (tridiagonal)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dprecurve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dprecurve</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dprecurve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dprecurve</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># n x 1</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dRhub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dRhub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dRtip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dRtip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dprecone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dprecone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dtilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dtilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dhubHt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dhubHt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dyaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dyaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dazimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dazimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dUinf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dUinf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dOmega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dOmega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dNp</span><span class="p">[</span><span class="s1">&#39;dpitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dNp_dX</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dTp</span><span class="p">[</span><span class="s1">&#39;dpitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTp_dX</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">dNp</span><span class="p">,</span> <span class="n">dTp</span></div>




<div class="viewcode-block" id="CCBlade.evaluate"><a class="viewcode-back" href="../../documentation.html#ccblade.CCBlade.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">coefficients</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the aerodynamic analysis at the specified conditions.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Uinf : array_like (m/s)</span>
<span class="sd">            hub height wind speed</span>
<span class="sd">        Omega : array_like (RPM)</span>
<span class="sd">            rotor rotation speed</span>
<span class="sd">        pitch : array_like (deg)</span>
<span class="sd">            blade pitch setting</span>
<span class="sd">        coefficient : bool, optional</span>
<span class="sd">            if True, results are returned in nondimensional form</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        P or CP : ndarray (W)</span>
<span class="sd">            power or power coefficient</span>
<span class="sd">        T or CT : ndarray (N)</span>
<span class="sd">            thrust or thrust coefficient (magnitude)</span>
<span class="sd">        Q or CQ : ndarray (N*m)</span>
<span class="sd">            torque or torque coefficient (magnitude)</span>
<span class="sd">        dP or dCP : dictionary of arrays (present only if derivatives==True)</span>
<span class="sd">            derivatives of power or power coefficient.  Each item in dictionary is a Jacobian.</span>
<span class="sd">            The array sizes and keys are below</span>
<span class="sd">            npts is the number of conditions (len(Uinf)),</span>
<span class="sd">            n = number of stations along blade (len(r))</span>
<span class="sd">            npts x 1: &#39;dprecone&#39;, &#39;dtilt&#39;, &#39;dhubHt&#39;, &#39;dRhub&#39;, &#39;dRtip&#39;, &#39;dprecurveTip&#39;, &#39;dpresweepTip&#39;, &#39;dyaw&#39;</span>
<span class="sd">            npts x npts: &#39;dUinf&#39;, &#39;dOmega&#39;, &#39;dpitch&#39;</span>
<span class="sd">            npts x n: &#39;dr&#39;, &#39;dchord&#39;, &#39;dtheta&#39;, &#39;dprecurve&#39;, &#39;dpresweep&#39;</span>
<span class="sd">            for example dP_dr = dP[&#39;dr&#39;]  (where dP_dr is an npts x n array)</span>
<span class="sd">            and dP_dr[i, j] = dP_i / dr_j</span>
<span class="sd">        dT or dCT : dictionary of arrays (present only if derivatives==True)</span>
<span class="sd">            derivative of thrust or thrust coefficient.  Same format as dP and dCP</span>
<span class="sd">        dQ or dCQ : dictionary of arrays (present only if derivatives==True)</span>
<span class="sd">            derivative of torque or torque coefficient.  Same format as dP and dCP</span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        CP = P / (q * Uinf * A)</span>
<span class="sd">        CT = T / (q * A)</span>
<span class="sd">        CQ = Q / (q * A * R)</span>
<span class="sd">        The rotor radius R, may not actually be Rtip if precone and precurve are both nonzero</span>
<span class="sd">        ``R = Rtip*cos(precone) + precurveTip*sin(precone)``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># rename</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">presweep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Rhub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurveTip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">presweepTip</span><span class="p">)</span>
        <span class="n">nsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSector</span>

        <span class="c1"># initialize</span>
        <span class="n">Uinf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Uinf</span><span class="p">)</span>
        <span class="n">Omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Omega</span><span class="p">)</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span>

        <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Uinf</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
            <span class="n">dT_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">dQ_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">dT_dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)))</span>
            <span class="n">dQ_dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span><span class="p">):</span>  <span class="c1"># iterate across conditions</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsec</span><span class="p">):</span>  <span class="c1"># integrate across azimuth</span>
                <span class="n">azimuth</span> <span class="o">=</span> <span class="mf">360.0</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">nsec</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
                    <span class="c1"># contribution from this azimuthal location</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">induction</span><span class="p">:</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributedAeroLoads</span><span class="p">(</span><span class="n">Uinf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">azimuth</span><span class="p">)</span>
                        <span class="c1"># Induction</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="n">a</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributedAeroLoads</span><span class="p">(</span><span class="n">Uinf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">azimuth</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">dNp</span><span class="p">,</span> <span class="n">dTp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributedAeroLoads</span><span class="p">(</span><span class="n">Uinf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Omega</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pitch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">azimuth</span><span class="p">)</span>

                    <span class="n">dT_ds_sub</span><span class="p">,</span> <span class="n">dQ_ds_sub</span><span class="p">,</span> <span class="n">dT_dv_sub</span><span class="p">,</span> <span class="n">dQ_dv_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thrustTorqueDeriv</span><span class="p">(</span>
                        <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dNp_dX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dTp_dX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dNp_dprecurve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dTp_dprecurve</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

                    <span class="n">dT_ds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">dT_ds_sub</span> <span class="o">/</span> <span class="n">nsec</span>
                    <span class="n">dQ_ds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">dQ_ds_sub</span> <span class="o">/</span> <span class="n">nsec</span>
                    <span class="n">dT_dv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">dT_dv_sub</span> <span class="o">/</span> <span class="n">nsec</span>
                    <span class="n">dQ_dv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">dQ_dv_sub</span> <span class="o">/</span> <span class="n">nsec</span>


                <span class="n">Tsub</span><span class="p">,</span> <span class="n">Qsub</span><span class="p">,</span> <span class="n">Msub</span> <span class="o">=</span> <span class="n">_bem</span><span class="o">.</span><span class="n">thrusttorque</span><span class="p">(</span><span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">Tsub</span> <span class="o">/</span> <span class="n">nsec</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">Qsub</span> <span class="o">/</span> <span class="n">nsec</span>
                <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">*</span> <span class="n">Msub</span> <span class="o">/</span> <span class="n">nsec</span>


        
        
        <span class="c1"># Power</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">Omega</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span>  <span class="c1"># RPM to rad/s</span>
        
        
        
        <span class="c1"># normalize if necessary</span>
        <span class="k">if</span> <span class="n">coefficients</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">Uinf</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">CP</span> <span class="o">=</span> <span class="n">P</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">Uinf</span><span class="p">)</span>
            <span class="n">CT</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
            <span class="n">CQ</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
            <span class="n">CM</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>

                <span class="c1"># s = [precone, tilt, hubHt, Rhub, Rtip, precurvetip, presweeptip, yaw, Uinf, Omega, pitch]</span>

                <span class="n">dR_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Rtip</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">precurveTip</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">,</span>
                    <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precone</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="n">dR_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dR_ds</span><span class="p">]))</span>  <span class="c1"># same for each operating condition</span>

                <span class="n">dA_ds</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span><span class="o">*</span><span class="n">dR_ds</span>

                <span class="n">dU_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                <span class="n">dU_ds</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="n">dOmega_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                <span class="n">dOmega_ds</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="n">dq_ds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">dU_ds</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

                <span class="n">dCT_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">CT</span> <span class="o">*</span> <span class="p">(</span><span class="n">dT_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">T</span> <span class="o">-</span> <span class="n">dA_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">A</span> <span class="o">-</span> <span class="n">dq_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">q</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">dCT_dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dT_dv</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                <span class="n">dCQ_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">CQ</span> <span class="o">*</span> <span class="p">(</span><span class="n">dQ_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">Q</span> <span class="o">-</span> <span class="n">dA_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">A</span> <span class="o">-</span> <span class="n">dq_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">q</span> <span class="o">-</span> <span class="n">dR_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">dCQ_dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dQ_dv</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rotorR</span><span class="o">*</span><span class="n">A</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                <span class="n">dCP_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">CP</span> <span class="o">*</span> <span class="p">(</span><span class="n">dQ_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">Q</span> <span class="o">+</span> <span class="n">dOmega_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">Omega</span> <span class="o">-</span> <span class="n">dA_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">A</span> <span class="o">-</span> <span class="n">dq_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">q</span> <span class="o">-</span> <span class="n">dU_ds</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">Uinf</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">dCP_dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dQ_dv</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">CP</span><span class="o">/</span><span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># pack derivatives into dictionary</span>
                <span class="n">dCT</span><span class="p">,</span> <span class="n">dCQ</span><span class="p">,</span> <span class="n">dCP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thrustTorqueDictionary</span><span class="p">(</span><span class="n">dCT_ds</span><span class="p">,</span> <span class="n">dCQ_ds</span><span class="p">,</span> <span class="n">dCP_ds</span><span class="p">,</span> <span class="n">dCT_dv</span><span class="p">,</span> <span class="n">dCQ_dv</span><span class="p">,</span> <span class="n">dCP_dv</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>




        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
            <span class="c1"># scalars = [precone, tilt, hubHt, Rhub, Rtip, precurvetip, presweeptip, yaw, Uinf, Omega, pitch]</span>
            <span class="c1"># vectors = [r, chord, theta, precurve, presweep]</span>

            <span class="n">dP_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">dQ_ds</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Omega</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Q</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span>
            <span class="n">dP_dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">dQ_dv</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">Omega</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># pack derivatives into dictionary</span>
            <span class="n">dT</span><span class="p">,</span> <span class="n">dQ</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thrustTorqueDictionary</span><span class="p">(</span><span class="n">dT_ds</span><span class="p">,</span> <span class="n">dQ_ds</span><span class="p">,</span> <span class="n">dP_ds</span><span class="p">,</span> <span class="n">dT_dv</span><span class="p">,</span> <span class="n">dQ_dv</span><span class="p">,</span> <span class="n">dP_dv</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">coefficients</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">dQ</span><span class="p">,</span> <span class="n">CP</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">CQ</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">dCP</span><span class="p">,</span> <span class="n">dCT</span><span class="p">,</span> <span class="n">dCQ</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">CP</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">CQ</span><span class="p">,</span> <span class="n">CM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">dQ</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">M</span></div>




    <span class="k">def</span> <span class="nf">__thrustTorqueDeriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">dNp_dX</span><span class="p">,</span> <span class="n">dTp_dX</span><span class="p">,</span> <span class="n">dNp_dprecurve</span><span class="p">,</span> <span class="n">dTp_dprecurve</span><span class="p">,</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">precurve</span><span class="p">,</span> <span class="n">presweep</span><span class="p">,</span> <span class="n">precone</span><span class="p">,</span> <span class="n">Rhub</span><span class="p">,</span> <span class="n">Rtip</span><span class="p">,</span> <span class="n">precurveTip</span><span class="p">,</span> <span class="n">presweepTip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;derivatives of thrust and torque&quot;&quot;&quot;</span>

        <span class="n">Tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">Qb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">Npb</span><span class="p">,</span> <span class="n">Tpb</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">precurveb</span><span class="p">,</span> <span class="n">presweepb</span><span class="p">,</span> <span class="n">preconeb</span><span class="p">,</span> <span class="n">Rhubb</span><span class="p">,</span> <span class="n">Rtipb</span><span class="p">,</span> <span class="n">precurvetipb</span><span class="p">,</span> <span class="n">presweeptipb</span> <span class="o">=</span> \
            <span class="n">_bem</span><span class="o">.</span><span class="n">thrusttorque_bv</span><span class="p">(</span><span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">precurve</span><span class="p">,</span> <span class="n">presweep</span><span class="p">,</span> <span class="n">precone</span><span class="p">,</span> <span class="n">Rhub</span><span class="p">,</span> <span class="n">Rtip</span><span class="p">,</span> <span class="n">precurveTip</span><span class="p">,</span> <span class="n">presweepTip</span><span class="p">,</span> <span class="n">Tb</span><span class="p">,</span> <span class="n">Qb</span><span class="p">)</span>


        <span class="c1"># X = [r, chord, theta, Rhub, Rtip, presweep, precone, tilt, hubHt, yaw, azimuth, Uinf, Omega, pitch]</span>
        <span class="n">dT_dNp</span> <span class="o">=</span> <span class="n">Npb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dNp</span> <span class="o">=</span> <span class="n">Npb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dTp</span> <span class="o">=</span> <span class="n">Tpb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dTp</span> <span class="o">=</span> <span class="n">Tpb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># chain rule</span>
        <span class="n">dT_dX</span> <span class="o">=</span> <span class="n">dT_dNp</span><span class="o">*</span><span class="n">dNp_dX</span> <span class="o">+</span> <span class="n">dT_dTp</span><span class="o">*</span><span class="n">dTp_dX</span>
        <span class="n">dQ_dX</span> <span class="o">=</span> <span class="n">dQ_dNp</span><span class="o">*</span><span class="n">dNp_dX</span> <span class="o">+</span> <span class="n">dQ_dTp</span><span class="o">*</span><span class="n">dTp_dX</span>

        <span class="n">dT_dr</span> <span class="o">=</span> <span class="n">dT_dX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">rb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dr</span> <span class="o">=</span> <span class="n">dQ_dX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">rb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dchord</span> <span class="o">=</span> <span class="n">dT_dX</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dchord</span> <span class="o">=</span> <span class="n">dQ_dX</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dtheta</span> <span class="o">=</span> <span class="n">dT_dX</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dtheta</span> <span class="o">=</span> <span class="n">dQ_dX</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dRhub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">Rhubb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dQ_dRhub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">Rhubb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dT_dRtip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">Rtipb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dQ_dRtip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">Rtipb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dT_dpresweep</span> <span class="o">=</span> <span class="n">dT_dX</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">presweepb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dpresweep</span> <span class="o">=</span> <span class="n">dQ_dX</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">presweepb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dprecone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">preconeb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>
        <span class="n">dQ_dprecone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">preconeb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>
        <span class="n">dT_dtilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dtilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dT_dhubht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dhubht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dT_dprecurvetip</span> <span class="o">=</span> <span class="n">precurvetipb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dQ_dprecurvetip</span> <span class="o">=</span> <span class="n">precurvetipb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dT_dpresweeptip</span> <span class="o">=</span> <span class="n">presweeptipb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dQ_dpresweeptip</span> <span class="o">=</span> <span class="n">presweeptipb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dT_dprecurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dNp</span><span class="o">*</span><span class="n">dNp_dprecurve</span> <span class="o">+</span> <span class="n">dT_dTp</span><span class="o">*</span><span class="n">dTp_dprecurve</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">precurveb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ_dprecurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dNp</span><span class="o">*</span><span class="n">dNp_dprecurve</span> <span class="o">+</span> <span class="n">dQ_dTp</span><span class="o">*</span><span class="n">dTp_dprecurve</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">precurveb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT_dyaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dyaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dT_dUinf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dUinf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dT_dOmega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dOmega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dT_dpitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dT_dX</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dQ_dpitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dQ_dX</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="p">:])</span>


        <span class="c1"># scalars = [precone, tilt, hubHt, Rhub, Rtip, precurvetip, presweeptip, yaw, Uinf, Omega, pitch]</span>
        <span class="n">dT_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dT_dprecone</span><span class="p">,</span> <span class="n">dT_dtilt</span><span class="p">,</span> <span class="n">dT_dhubht</span><span class="p">,</span> <span class="n">dT_dRhub</span><span class="p">,</span> <span class="n">dT_dRtip</span><span class="p">,</span>
            <span class="n">dT_dprecurvetip</span><span class="p">,</span> <span class="n">dT_dpresweeptip</span><span class="p">,</span> <span class="n">dT_dyaw</span><span class="p">,</span> <span class="n">dT_dUinf</span><span class="p">,</span> <span class="n">dT_dOmega</span><span class="p">,</span> <span class="n">dT_dpitch</span><span class="p">])</span>
        <span class="n">dQ_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dQ_dprecone</span><span class="p">,</span> <span class="n">dQ_dtilt</span><span class="p">,</span> <span class="n">dQ_dhubht</span><span class="p">,</span> <span class="n">dQ_dRhub</span><span class="p">,</span> <span class="n">dQ_dRtip</span><span class="p">,</span>
            <span class="n">dQ_dprecurvetip</span><span class="p">,</span> <span class="n">dQ_dpresweeptip</span><span class="p">,</span> <span class="n">dQ_dyaw</span><span class="p">,</span> <span class="n">dQ_dUinf</span><span class="p">,</span> <span class="n">dQ_dOmega</span><span class="p">,</span> <span class="n">dQ_dpitch</span><span class="p">])</span>


        <span class="c1"># vectors = [r, chord, theta, precurve, presweep]</span>
        <span class="n">dT_dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dT_dr</span><span class="p">,</span> <span class="n">dT_dchord</span><span class="p">,</span> <span class="n">dT_dtheta</span><span class="p">,</span> <span class="n">dT_dprecurve</span><span class="p">,</span> <span class="n">dT_dpresweep</span><span class="p">))</span>
        <span class="n">dQ_dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dQ_dr</span><span class="p">,</span> <span class="n">dQ_dchord</span><span class="p">,</span> <span class="n">dQ_dtheta</span><span class="p">,</span> <span class="n">dQ_dprecurve</span><span class="p">,</span> <span class="n">dQ_dpresweep</span><span class="p">))</span>


        <span class="k">return</span> <span class="n">dT_ds</span><span class="p">,</span> <span class="n">dQ_ds</span><span class="p">,</span> <span class="n">dT_dv</span><span class="p">,</span> <span class="n">dQ_dv</span>



    <span class="k">def</span> <span class="nf">__thrustTorqueDictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dT_ds</span><span class="p">,</span> <span class="n">dQ_ds</span><span class="p">,</span> <span class="n">dP_ds</span><span class="p">,</span> <span class="n">dT_dv</span><span class="p">,</span> <span class="n">dQ_dv</span><span class="p">,</span> <span class="n">dP_dv</span><span class="p">,</span> <span class="n">npts</span><span class="p">):</span>

        <span class="c1"># pack derivatives into dictionary</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dQ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dP</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># npts x 1</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dprecone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dprecone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dprecone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dtilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dtilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dtilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dhubHt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dhubHt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dhubHt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dRhub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dRhub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dRhub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dRtip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dRtip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dRtip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dprecurveTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dprecurveTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dprecurveTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dpresweepTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dpresweepTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dpresweepTip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dyaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dyaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dyaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


        <span class="c1"># npts x npts (diagonal)</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dUinf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dUinf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dUinf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dOmega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">])</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dOmega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">])</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dOmega&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">])</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dpitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dT_ds</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dpitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dQ_ds</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dpitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dP_ds</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">])</span>


        <span class="c1"># npts x n</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_dv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_dv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_dv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dchord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_dv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dchord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_dv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dchord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_dv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_dv</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_dv</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dtheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_dv</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dprecurve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_dv</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dprecurve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_dv</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dprecurve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_dv</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dT</span><span class="p">[</span><span class="s1">&#39;dpresweep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_dv</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dQ</span><span class="p">[</span><span class="s1">&#39;dpresweep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_dv</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dP</span><span class="p">[</span><span class="s1">&#39;dpresweep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_dv</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">dT</span><span class="p">,</span> <span class="n">dQ</span><span class="p">,</span> <span class="n">dP</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># geometry</span>
    <span class="n">Rhub</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">Rtip</span> <span class="o">=</span> <span class="mf">63.0</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.8667</span><span class="p">,</span> <span class="mf">5.6000</span><span class="p">,</span> <span class="mf">8.3333</span><span class="p">,</span> <span class="mf">11.7500</span><span class="p">,</span> <span class="mf">15.8500</span><span class="p">,</span> <span class="mf">19.9500</span><span class="p">,</span> <span class="mf">24.0500</span><span class="p">,</span>
                  <span class="mf">28.1500</span><span class="p">,</span> <span class="mf">32.2500</span><span class="p">,</span> <span class="mf">36.3500</span><span class="p">,</span> <span class="mf">40.4500</span><span class="p">,</span> <span class="mf">44.5500</span><span class="p">,</span> <span class="mf">48.6500</span><span class="p">,</span> <span class="mf">52.7500</span><span class="p">,</span>
                  <span class="mf">56.1667</span><span class="p">,</span> <span class="mf">58.9000</span><span class="p">,</span> <span class="mf">61.6333</span><span class="p">])</span>
    <span class="n">chord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.542</span><span class="p">,</span> <span class="mf">3.854</span><span class="p">,</span> <span class="mf">4.167</span><span class="p">,</span> <span class="mf">4.557</span><span class="p">,</span> <span class="mf">4.652</span><span class="p">,</span> <span class="mf">4.458</span><span class="p">,</span> <span class="mf">4.249</span><span class="p">,</span> <span class="mf">4.007</span><span class="p">,</span> <span class="mf">3.748</span><span class="p">,</span>
                      <span class="mf">3.502</span><span class="p">,</span> <span class="mf">3.256</span><span class="p">,</span> <span class="mf">3.010</span><span class="p">,</span> <span class="mf">2.764</span><span class="p">,</span> <span class="mf">2.518</span><span class="p">,</span> <span class="mf">2.313</span><span class="p">,</span> <span class="mf">2.086</span><span class="p">,</span> <span class="mf">1.419</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">13.308</span><span class="p">,</span> <span class="mf">13.308</span><span class="p">,</span> <span class="mf">13.308</span><span class="p">,</span> <span class="mf">13.308</span><span class="p">,</span> <span class="mf">11.480</span><span class="p">,</span> <span class="mf">10.162</span><span class="p">,</span> <span class="mf">9.011</span><span class="p">,</span> <span class="mf">7.795</span><span class="p">,</span>
                      <span class="mf">6.544</span><span class="p">,</span> <span class="mf">5.361</span><span class="p">,</span> <span class="mf">4.188</span><span class="p">,</span> <span class="mf">3.125</span><span class="p">,</span> <span class="mf">2.319</span><span class="p">,</span> <span class="mf">1.526</span><span class="p">,</span> <span class="mf">0.863</span><span class="p">,</span> <span class="mf">0.370</span><span class="p">,</span> <span class="mf">0.106</span><span class="p">])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># number of blades</span>

    <span class="c1"># atmosphere</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">1.225</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.81206e-5</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">afinit</span> <span class="o">=</span> <span class="n">CCAirfoil</span><span class="o">.</span><span class="n">initFromAerodynFile</span>  <span class="c1"># just for shorthand</span>
    <span class="n">basepath</span> <span class="o">=</span> <span class="s1">&#39;5MW_AFFiles&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>

    <span class="c1"># load all airfoils</span>
    <span class="n">airfoil_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;Cylinder1.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;Cylinder2.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;DU40_A17.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;DU35_A17.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;DU30_A17.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;DU25_A17.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;DU21_A17.dat&#39;</span><span class="p">)</span>
    <span class="n">airfoil_types</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">afinit</span><span class="p">(</span><span class="n">basepath</span> <span class="o">+</span> <span class="s1">&#39;NACA64_A17.dat&#39;</span><span class="p">)</span>

    <span class="c1"># place at appropriate radial stations</span>
    <span class="n">af_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>

    <span class="n">af</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
        <span class="n">af</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">airfoil_types</span><span class="p">[</span><span class="n">af_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>


    <span class="n">tilt</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span>
    <span class="n">precone</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">yaw</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">shearExp</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">hubHt</span> <span class="o">=</span> <span class="mf">80.0</span>
    <span class="n">nSector</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># create CCBlade object</span>
    <span class="n">aeroanalysis</span> <span class="o">=</span> <span class="n">CCBlade</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">af</span><span class="p">,</span> <span class="n">Rhub</span><span class="p">,</span> <span class="n">Rtip</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span>
                           <span class="n">precone</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">shearExp</span><span class="p">,</span> <span class="n">hubHt</span><span class="p">,</span> <span class="n">nSector</span><span class="p">)</span>


    <span class="c1"># set conditions</span>
    <span class="n">Uinf</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">tsr</span> <span class="o">=</span> <span class="mf">7.55</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">Uinf</span><span class="o">*</span><span class="n">tsr</span><span class="o">/</span><span class="n">Rtip</span> <span class="o">*</span> <span class="mf">30.0</span><span class="o">/</span><span class="n">pi</span>  <span class="c1"># convert to RPM</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="mi">90</span>

    <span class="c1"># evaluate distributed loads</span>
    <span class="n">Np</span><span class="p">,</span> <span class="n">Tp</span> <span class="o">=</span> <span class="n">aeroanalysis</span><span class="o">.</span><span class="n">distributedAeroLoads</span><span class="p">(</span><span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">)</span>

    <span class="c1"># plot</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># rstar = (rload - rload[0]) / (rload[-1] - rload[0])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Tp</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;lead-lag&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Np</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;flapwise&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;blade fraction&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;distributed aerodynamic loads (kN)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">CP</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">CQ</span> <span class="o">=</span> <span class="n">aeroanalysis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">([</span><span class="n">Uinf</span><span class="p">],</span> <span class="p">[</span><span class="n">Omega</span><span class="p">],</span> <span class="p">[</span><span class="n">pitch</span><span class="p">],</span> <span class="n">coefficient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">CP</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">CQ</span><span class="p">)</span>


    <span class="n">tsr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">tsr</span><span class="p">)</span>
    <span class="n">Uinf</span> <span class="o">=</span> <span class="n">Omega</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mf">30.0</span> <span class="o">*</span> <span class="n">Rtip</span><span class="o">/</span><span class="n">tsr</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tsr</span><span class="p">)</span>

    <span class="n">CP</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">CQ</span> <span class="o">=</span> <span class="n">aeroanalysis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Uinf</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">coefficient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tsr</span><span class="p">,</span> <span class="n">CP</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$\lambda$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$c_p$&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CCBlade 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, NREL.
      Last updated on Apr 08, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>